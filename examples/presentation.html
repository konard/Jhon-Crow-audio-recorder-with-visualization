<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Presentation Mode</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html, body {
      width: 100%;
      height: 100%;
      overflow: hidden;
      background: transparent;
      /* Enable hardware acceleration for smoother rendering */
      transform: translateZ(0);
      -webkit-transform: translateZ(0);
    }

    body {
      display: flex;
      align-items: center;
      justify-content: center;
      /* User can't select anything in presentation window */
      user-select: none;
      -webkit-user-select: none;
      /* Disable all mouse interactions by default (click-through) */
      pointer-events: none;
    }

    #visualizer {
      /* Canvas takes full window */
      width: 100%;
      height: 100%;
      /* Smooth scaling */
      image-rendering: optimizeQuality;
      /* Hardware acceleration */
      transform: translateZ(0);
      -webkit-transform: translateZ(0);
    }

    /* Background layer with configurable opacity */
    #background-layer {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      background: #000;
      opacity: 0;
      pointer-events: none;
    }
  </style>
</head>
<body>
  <!-- Background layer for optional solid background -->
  <div id="background-layer"></div>

  <!-- Visualization canvas -->
  <canvas id="visualizer"></canvas>

  <script src="../dist/audio-recorder-visualization.umd.js"></script>
  <script>
    (async function() {
      // Wait for library to load
      await new Promise(resolve => {
        if (window.AudioRecorderVisualization) {
          resolve();
        } else {
          const interval = setInterval(() => {
            if (window.AudioRecorderVisualization) {
              clearInterval(interval);
              resolve();
            }
          }, 100);
        }
      });

      const canvas = document.getElementById('visualizer');
      const backgroundLayer = document.getElementById('background-layer');
      const ctx = canvas.getContext('2d');

      // Presentation settings
      let settings = {
        backgroundOpacity: 0,
        visualizerType: 'bars',
        visualizerOptions: {},
      };

      // Resize canvas to window
      function resizeCanvas() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
      }

      window.addEventListener('resize', resizeCanvas);
      resizeCanvas();

      // Update background opacity
      function updateBackgroundOpacity(opacity) {
        backgroundLayer.style.opacity = opacity;
      }

      // Create visualizer instance (will receive frame data from main window)
      let currentVisualizerType = 'bars';
      let visualizerOptions = {
        primaryColor: '#00ff88',
        secondaryColor: '#0088ff',
        backgroundColor: 'transparent', // Always transparent for presentation
        barCount: 64,
        mirror: false,
        mirrorHorizontal: false,
        visualizationAlpha: 1,
        offsetX: 0,
        offsetY: 0,
        scale: 1,
      };

      // Get the visualizer class
      const {
        BarVisualizer,
        WaveformVisualizer,
        CircularVisualizer,
        ParticleVisualizer,
        SpectrumGradientVisualizer,
        GlowWaveformVisualizer,
        VUMeterVisualizer,
        SpectrogramVisualizer,
        SpiralWaveformVisualizer,
        RadialBarsVisualizer,
        FrequencyRingsVisualizer,
      } = window.AudioRecorderVisualization;

      const visualizerMap = {
        'bars': BarVisualizer,
        'waveform': WaveformVisualizer,
        'circular': CircularVisualizer,
        'particles': ParticleVisualizer,
        'spectrum-gradient': SpectrumGradientVisualizer,
        'glow-waveform': GlowWaveformVisualizer,
        'vu-meter': VUMeterVisualizer,
        'spectrogram': SpectrogramVisualizer,
        'spiral-waveform': SpiralWaveformVisualizer,
        'radial-bars': RadialBarsVisualizer,
        'frequency-rings': FrequencyRingsVisualizer,
      };

      let visualizer = null;

      // Create/recreate visualizer
      async function createVisualizer(type, options) {
        const VisualizerClass = visualizerMap[type] || BarVisualizer;

        // Always set backgroundColor to transparent for presentation
        const presentationOptions = {
          ...options,
          backgroundColor: 'transparent',
        };

        visualizer = new VisualizerClass(canvas, presentationOptions);
        currentVisualizerType = type;

        // Wait for visualizer to be ready (images to load, etc.)
        if (visualizer.ready) {
          await visualizer.ready();
        }
      }

      // Initialize with default visualizer
      await createVisualizer(currentVisualizerType, visualizerOptions);

      // Handle settings updates from main process
      if (window.presentationAPI) {
        window.presentationAPI.onSettings((newSettings) => {
          settings = { ...settings, ...newSettings };

          // Update background opacity
          if (newSettings.backgroundOpacity !== undefined) {
            updateBackgroundOpacity(newSettings.backgroundOpacity);
          }
        });

        // Handle frame data from main window
        window.presentationAPI.onFrame((frameData) => {
          if (!visualizer) return;

          // Render frame with the received audio data
          if (frameData && frameData.frequencyData && frameData.timeDomainData) {
            // Convert arrays back to Uint8Array if needed
            const frequencyData = frameData.frequencyData instanceof Uint8Array
              ? frameData.frequencyData
              : new Uint8Array(frameData.frequencyData);
            const timeDomainData = frameData.timeDomainData instanceof Uint8Array
              ? frameData.timeDomainData
              : new Uint8Array(frameData.timeDomainData);

            // Clear canvas with transparent background
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Draw visualization
            visualizer.draw(frequencyData, timeDomainData);
          }
        });

        // Handle visualizer options changes
        window.presentationAPI.onVisualizerOptions(async (options) => {
          visualizerOptions = { ...visualizerOptions, ...options };

          // Always ensure transparent background for presentation
          visualizerOptions.backgroundColor = 'transparent';

          // Update visualizer options
          if (visualizer && visualizer.setOptions) {
            await visualizer.setOptions(visualizerOptions);
          } else {
            // Recreate visualizer with new options
            await createVisualizer(currentVisualizerType, visualizerOptions);
          }
        });

        // Handle visualizer type changes
        window.presentationAPI.onVisualizerType(async (type) => {
          if (type !== currentVisualizerType) {
            await createVisualizer(type, visualizerOptions);
          }
        });
      }

      // Keyboard event handler for Alt+Q (backup in case main process doesn't catch it)
      // Note: This is mostly handled by the main process, but we add a fallback here
      document.addEventListener('keydown', (e) => {
        // Block Alt+F4 completely (handled by main process, but we prevent default here too)
        if (e.key === 'F4' && e.altKey) {
          e.preventDefault();
          e.stopPropagation();
          return false;
        }

        // Alt+Tab - let it pass through (handled by OS, we don't block it)
        // Nothing to do here as the window is click-through
      });

      // Prevent context menu
      document.addEventListener('contextmenu', (e) => {
        e.preventDefault();
      });

      console.log('Presentation window initialized');
    })();
  </script>
</body>
</html>
