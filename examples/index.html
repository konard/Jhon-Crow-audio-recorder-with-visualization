<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Audio Recorder with Visualization</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    :root {
      /* Modern color palette with better contrast */
      --color-primary: #00ff88;
      --color-primary-dark: #00cc6a;
      --color-secondary: #0088ff;
      --color-secondary-dark: #0066cc;
      --color-danger: #ff4444;
      --color-danger-dark: #cc0000;
      --color-warning: #ffaa00;
      --color-success: #00ff88;

      /* Neutral colors */
      --color-bg-primary: #0a0e27;
      --color-bg-secondary: #16213e;
      --color-bg-tertiary: #1a1a2e;
      --color-surface: rgba(255, 255, 255, 0.05);
      --color-surface-hover: rgba(255, 255, 255, 0.08);
      --color-border: rgba(255, 255, 255, 0.1);
      --color-text-primary: #ffffff;
      --color-text-secondary: rgba(255, 255, 255, 0.7);
      --color-text-muted: rgba(255, 255, 255, 0.5);

      /* Shadows */
      --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.2);
      --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.3);
      --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.4);
      --shadow-glow: 0 0 20px rgba(0, 255, 136, 0.3);

      /* Spacing */
      --spacing-xs: 4px;
      --spacing-sm: 8px;
      --spacing-md: 16px;
      --spacing-lg: 24px;
      --spacing-xl: 32px;

      /* Border radius */
      --radius-sm: 6px;
      --radius-md: 8px;
      --radius-lg: 12px;
      --radius-xl: 16px;

      /* Transitions */
      --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
      --transition-base: 250ms cubic-bezier(0.4, 0, 0.2, 1);
      --transition-slow: 350ms cubic-bezier(0.4, 0, 0.2, 1);
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, 'Helvetica Neue', sans-serif;
      background: linear-gradient(135deg, var(--color-bg-primary) 0%, var(--color-bg-secondary) 50%, var(--color-bg-tertiary) 100%);
      background-attachment: fixed;
      color: var(--color-text-primary);
      min-height: 100vh;
      padding: var(--spacing-lg);
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      animation: fadeIn var(--transition-slow) ease-out;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    h1 {
      text-align: center;
      margin-bottom: var(--spacing-xl);
      font-size: clamp(2rem, 5vw, 3rem);
      font-weight: 700;
      background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      letter-spacing: -0.5px;
      animation: slideDown var(--transition-slow) ease-out;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .canvas-container {
      display: flex;
      justify-content: center;
      margin-bottom: var(--spacing-lg);
      position: relative;
      animation: scaleIn var(--transition-slow) ease-out 0.1s both;
    }

    @keyframes scaleIn {
      from {
        opacity: 0;
        transform: scale(0.95);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    #visualizer {
      border: 2px solid var(--color-border);
      border-radius: var(--radius-lg);
      background: #000;
      box-shadow: var(--shadow-lg), 0 0 40px rgba(0, 136, 255, 0.1);
      transition: box-shadow var(--transition-base), transform var(--transition-base);
      max-width: 100%;
      height: auto;
    }

    #visualizer:hover {
      box-shadow: var(--shadow-lg), var(--shadow-glow);
      transform: translateY(-2px);
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: var(--spacing-md);
      justify-content: center;
      margin-bottom: var(--spacing-lg);
      animation: fadeIn var(--transition-slow) ease-out 0.2s both;
    }

    button {
      padding: 14px 28px;
      border: none;
      border-radius: var(--radius-md);
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all var(--transition-base);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: var(--spacing-sm);
      position: relative;
      overflow: hidden;
      box-shadow: var(--shadow-sm);
      letter-spacing: 0.3px;
      min-width: 140px;
    }

    button::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      transform: translate(-50%, -50%);
      transition: width var(--transition-slow), height var(--transition-slow);
    }

    button:hover::before {
      width: 300px;
      height: 300px;
    }

    button:active {
      transform: scale(0.97);
    }

    button:hover:not(:disabled) {
      transform: translateY(-3px);
      box-shadow: var(--shadow-md);
    }

    button:disabled {
      opacity: 0.4;
      cursor: not-allowed;
      transform: none !important;
      filter: grayscale(0.3);
    }

    button:focus-visible {
      outline: 2px solid var(--color-primary);
      outline-offset: 2px;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--color-primary), var(--color-primary-dark));
      color: #000;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    .btn-primary:hover:not(:disabled) {
      box-shadow: 0 4px 16px rgba(0, 255, 136, 0.4);
    }

    .btn-danger {
      background: linear-gradient(135deg, var(--color-danger), var(--color-danger-dark));
      color: #fff;
    }

    .btn-danger:hover:not(:disabled) {
      box-shadow: 0 4px 16px rgba(255, 68, 68, 0.4);
    }

    .btn-secondary {
      background: linear-gradient(135deg, #555, #333);
      color: #fff;
    }

    .btn-secondary:hover:not(:disabled) {
      background: linear-gradient(135deg, #666, #444);
    }

    .btn-info {
      background: linear-gradient(135deg, var(--color-secondary), var(--color-secondary-dark));
      color: #fff;
    }

    .btn-info:hover:not(:disabled) {
      box-shadow: 0 4px 16px rgba(0, 136, 255, 0.4);
    }

    .options {
      background: var(--color-surface);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      padding: var(--spacing-lg);
      border-radius: var(--radius-lg);
      margin-bottom: var(--spacing-lg);
      border: 1px solid var(--color-border);
      box-shadow: var(--shadow-md);
      animation: fadeIn var(--transition-slow) ease-out 0.3s both;
    }

    .options h3 {
      margin: 0 0 var(--spacing-lg) 0;
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--color-text-primary);
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
    }

    .option-group {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: var(--spacing-md);
      margin-bottom: var(--spacing-md);
    }

    .option-group label {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-sm);
      color: var(--color-text-secondary);
      font-size: 14px;
      font-weight: 500;
      transition: color var(--transition-fast);
    }

    .option-group label:hover {
      color: var(--color-text-primary);
    }

    .option-group select,
    .option-group input[type="color"],
    .option-group input[type="file"],
    .option-group input[type="range"] {
      padding: 10px 12px;
      border: 1px solid var(--color-border);
      border-radius: var(--radius-sm);
      background: rgba(0, 0, 0, 0.3);
      color: var(--color-text-primary);
      min-width: 150px;
      font-size: 14px;
      transition: all var(--transition-fast);
    }

    .option-group select:hover,
    .option-group input[type="file"]:hover {
      background: rgba(0, 0, 0, 0.4);
      border-color: var(--color-primary);
    }

    .option-group select:focus,
    .option-group input[type="file"]:focus {
      outline: none;
      border-color: var(--color-primary);
      box-shadow: 0 0 0 3px rgba(0, 255, 136, 0.1);
    }

    .option-group input[type="color"] {
      height: 44px;
      cursor: pointer;
      padding: 4px;
    }

    .option-group input[type="color"]::-webkit-color-swatch-wrapper {
      padding: 2px;
    }

    .option-group input[type="color"]::-webkit-color-swatch {
      border: none;
      border-radius: var(--radius-sm);
    }

    .option-group input[type="range"] {
      padding: 0;
      height: 6px;
      -webkit-appearance: none;
      appearance: none;
      background: linear-gradient(to right, var(--color-primary) 0%, var(--color-secondary) 100%);
      border-radius: 3px;
      cursor: pointer;
    }

    .option-group input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 18px;
      height: 18px;
      background: #fff;
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
      transition: transform var(--transition-fast);
    }

    .option-group input[type="range"]::-webkit-slider-thumb:hover {
      transform: scale(1.2);
    }

    .option-group input[type="range"]::-moz-range-thumb {
      width: 18px;
      height: 18px;
      background: #fff;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
      transition: transform var(--transition-fast);
    }

    .option-group input[type="range"]::-moz-range-thumb:hover {
      transform: scale(1.2);
    }

    .option-group input[type="checkbox"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
      accent-color: var(--color-primary);
    }

    .status {
      text-align: center;
      padding: var(--spacing-md);
      border-radius: var(--radius-md);
      margin-bottom: var(--spacing-lg);
      font-weight: 500;
      font-size: 15px;
      transition: all var(--transition-base);
      animation: fadeIn var(--transition-slow) ease-out 0.15s both;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--spacing-sm);
    }

    .status::before {
      content: '';
      width: 10px;
      height: 10px;
      border-radius: 50%;
      display: inline-block;
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% {
        opacity: 1;
        transform: scale(1);
      }
      50% {
        opacity: 0.6;
        transform: scale(1.1);
      }
    }

    .status.recording {
      background: rgba(255, 68, 68, 0.15);
      border: 1px solid var(--color-danger);
      color: #ff6666;
    }

    .status.recording::before {
      background: var(--color-danger);
    }

    .status.ready {
      background: rgba(0, 255, 136, 0.15);
      border: 1px solid var(--color-primary);
      color: var(--color-primary);
    }

    .status.ready::before {
      background: var(--color-primary);
    }

    .status.error {
      background: rgba(255, 68, 68, 0.2);
      border: 1px solid var(--color-danger);
      color: #ff8888;
    }

    .status.error::before {
      background: var(--color-danger);
      animation: none;
    }

    .recordings {
      margin-top: var(--spacing-xl);
      animation: fadeIn var(--transition-slow) ease-out 0.4s both;
    }

    .recordings h3 {
      margin-bottom: var(--spacing-lg);
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--color-text-primary);
    }

    .recording-item {
      display: flex;
      align-items: center;
      gap: var(--spacing-lg);
      background: var(--color-surface);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      padding: var(--spacing-lg);
      border-radius: var(--radius-lg);
      margin-bottom: var(--spacing-md);
      border: 1px solid var(--color-border);
      transition: all var(--transition-base);
      animation: slideInUp var(--transition-slow) ease-out;
    }

    @keyframes slideInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .recording-item:hover {
      background: var(--color-surface-hover);
      border-color: var(--color-primary);
      box-shadow: var(--shadow-md);
      transform: translateX(4px);
    }

    .recording-item video {
      max-width: 240px;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all var(--transition-base);
      box-shadow: var(--shadow-sm);
    }

    .recording-item video:hover {
      box-shadow: 0 4px 16px rgba(0, 255, 136, 0.3);
      transform: scale(1.05);
    }

    .recording-item a {
      color: var(--color-primary);
      text-decoration: none;
      font-weight: 500;
      transition: color var(--transition-fast);
      display: inline-flex;
      align-items: center;
      gap: var(--spacing-xs);
    }

    .recording-item a:hover {
      color: var(--color-primary-dark);
      text-decoration: underline;
    }

    .recording-item p {
      margin: var(--spacing-xs) 0;
      color: var(--color-text-secondary);
      font-size: 14px;
    }

    .tab-container {
      margin-bottom: var(--spacing-lg);
      animation: fadeIn var(--transition-slow) ease-out 0.25s both;
    }

    .tabs {
      display: flex;
      gap: var(--spacing-xs);
      margin-bottom: var(--spacing-md);
      border-bottom: 2px solid var(--color-border);
    }

    .tab {
      padding: 12px 24px;
      background: transparent;
      border: none;
      border-radius: var(--radius-md) var(--radius-md) 0 0;
      color: var(--color-text-secondary);
      cursor: pointer;
      font-size: 15px;
      font-weight: 600;
      transition: all var(--transition-fast);
      position: relative;
    }

    .tab::after {
      content: '';
      position: absolute;
      bottom: -2px;
      left: 0;
      right: 0;
      height: 2px;
      background: var(--color-primary);
      transform: scaleX(0);
      transition: transform var(--transition-base);
    }

    .tab:hover {
      background: var(--color-surface);
      color: var(--color-text-primary);
    }

    .tab.active {
      background: var(--color-surface);
      color: var(--color-primary);
    }

    .tab.active::after {
      transform: scaleX(1);
    }

    .tab-content {
      display: none;
      background: var(--color-surface);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      padding: var(--spacing-lg);
      border-radius: 0 var(--radius-lg) var(--radius-lg) var(--radius-lg);
      border: 1px solid var(--color-border);
      animation: fadeIn var(--transition-base) ease-out;
    }

    .tab-content.active {
      display: block;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: var(--radius-sm);
      overflow: hidden;
      margin-top: var(--spacing-md);
      position: relative;
    }

    .progress-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--color-primary), var(--color-secondary));
      width: 0%;
      transition: width var(--transition-base) ease-out;
      position: relative;
      overflow: hidden;
    }

    .progress-bar-fill::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      bottom: 0;
      right: 0;
      background: linear-gradient(
        90deg,
        transparent,
        rgba(255, 255, 255, 0.3),
        transparent
      );
      animation: shimmer 2s infinite;
    }

    @keyframes shimmer {
      0% {
        transform: translateX(-100%);
      }
      100% {
        transform: translateX(100%);
      }
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      body {
        padding: var(--spacing-md);
      }

      h1 {
        font-size: 2rem;
        margin-bottom: var(--spacing-lg);
      }

      .controls {
        flex-direction: column;
        align-items: stretch;
      }

      button {
        width: 100%;
      }

      .option-group {
        grid-template-columns: 1fr;
      }

      .recording-item {
        flex-direction: column;
        align-items: flex-start;
      }

      .recording-item video {
        max-width: 100%;
      }

      .tabs {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }

      .tab {
        white-space: nowrap;
      }
    }

    /* Loading Spinner */
    .spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top-color: var(--color-primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* Tooltip */
    [data-tooltip] {
      position: relative;
      cursor: help;
    }

    [data-tooltip]::before {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%) translateY(-8px);
      padding: var(--spacing-sm) var(--spacing-md);
      background: rgba(0, 0, 0, 0.9);
      color: #fff;
      font-size: 12px;
      font-weight: 500;
      white-space: nowrap;
      border-radius: var(--radius-sm);
      opacity: 0;
      pointer-events: none;
      transition: opacity var(--transition-fast);
      z-index: 1000;
    }

    [data-tooltip]:hover::before {
      opacity: 1;
    }

    /* Focus visible for accessibility */
    *:focus-visible {
      outline: 2px solid var(--color-primary);
      outline-offset: 2px;
    }

    /* Smooth scrolling */
    html {
      scroll-behavior: smooth;
    }

    /* Selection styling */
    ::selection {
      background: var(--color-primary);
      color: #000;
    }

    ::-moz-selection {
      background: var(--color-primary);
      color: #000;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Audio Recorder with Visualization</h1>

    <div class="canvas-container">
      <canvas id="visualizer" width="800" height="400"></canvas>
    </div>

    <div id="status" class="status ready">Ready - Click "Start Microphone" to begin</div>

    <div class="tab-container">
      <div class="tabs">
        <button class="tab active" data-tab="microphone">Microphone Recording</button>
        <button class="tab" data-tab="convert">Audio to Video</button>
      </div>

      <div id="microphone" class="tab-content active">
        <div class="controls">
          <button id="startMic" class="btn-primary" data-tooltip="Start capturing audio from your microphone" aria-label="Start microphone">
            <span>Start Microphone</span>
          </button>
          <button id="stopMic" class="btn-secondary" disabled data-tooltip="Stop microphone capture" aria-label="Stop microphone">
            <span>Stop Microphone</span>
          </button>
          <button id="startRecord" class="btn-danger" disabled data-tooltip="Begin recording audio and visualization to video" aria-label="Start recording">
            <span>Start Recording</span>
          </button>
          <button id="stopRecord" class="btn-secondary" disabled data-tooltip="Stop recording and save video" aria-label="Stop recording">
            <span>Stop Recording</span>
          </button>
        </div>
      </div>

      <div id="convert" class="tab-content">
        <div class="option-group">
          <label>
            Audio File
            <input type="file" id="audioFile" accept="audio/*" aria-label="Select audio file to convert">
          </label>
          <label>
            Video Quality
            <select id="videoQuality" aria-label="Select video quality">
              <option value="720p">HD 720p (1280x720)</option>
              <option value="1080p" selected>Full HD 1080p (1920x1080)</option>
              <option value="1440p">2K 1440p (2560x1440)</option>
              <option value="2160p">4K 2160p (3840x2160)</option>
            </select>
          </label>
        </div>
        <div class="controls">
          <button id="convertBtn" class="btn-info" disabled data-tooltip="Convert selected audio file to video with visualization" aria-label="Convert audio to video">
            <span>Convert to Video</span>
          </button>
          <button id="cancelConvertBtn" class="btn-danger" style="display: none;" data-tooltip="Cancel video conversion" aria-label="Cancel conversion">
            <span>Cancel Conversion</span>
          </button>
        </div>
        <div class="progress-bar" style="display: none;" role="progressbar" aria-valuemin="0" aria-valuemax="100">
          <div class="progress-bar-fill" id="progressFill"></div>
        </div>
      </div>
    </div>

    <div class="options">
      <h3>
        <span aria-label="Settings icon">⚙️</span> Visualization Options
      </h3>
      <div class="option-group">
        <label>
          Visualizer Type
          <select id="visualizerSelect" aria-label="Select visualizer type">
            <option value="bars">Bars - Spectrum Analyzer</option>
            <option value="waveform">Waveform - Oscilloscope</option>
            <option value="circular">Circular - Radial Spectrum</option>
            <option value="particles">Particles - Audio-Reactive</option>
            <option value="spectrum-gradient">Spectrum Gradient - Winamp Style</option>
            <option value="glow-waveform">Glow Waveform - Modern Effect</option>
            <option value="vu-meter">VU Meter - Professional Style</option>
            <option value="spectrogram">Spectrogram - Frequency Waterfall</option>
            <option value="spiral-waveform">Spiral Waveform - Rotating Pattern</option>
            <option value="radial-bars">Radial Bars - Circular Analyzer</option>
            <option value="frequency-rings">Frequency Rings - Concentric Pulses</option>
          </select>
        </label>
        <label>
          Primary Color
          <input type="color" id="primaryColor" value="#00ff88" aria-label="Select primary color">
        </label>
        <label>
          Secondary Color
          <input type="color" id="secondaryColor" value="#0088ff" aria-label="Select secondary color">
        </label>
        <label>
          Background Color
          <input type="color" id="bgColor" value="#000000" aria-label="Select background color">
        </label>
        <label data-tooltip="Number of frequency bars (16-256)">
          Bar Count: <span id="barCountValue">64</span>
          <input type="range" id="barCount" min="16" max="256" value="64" aria-label="Adjust bar count">
        </label>
        <label>
          Background Image (optional)
          <input type="file" id="bgImage" accept="image/*" aria-label="Upload background image">
        </label>
        <label>
          Background Size Mode
          <select id="bgSizeMode" aria-label="Select background image size mode">
            <option value="cover" selected>Cover (Fill)</option>
            <option value="contain">Contain (Fit)</option>
            <option value="stretch">Stretch</option>
            <option value="tile">Tile</option>
            <option value="center">Center</option>
            <option value="custom">Custom Size</option>
          </select>
        </label>
      </div>
      <div class="option-group" id="customSizeControls" style="display: none;">
        <label>
          Custom Width (px)
          <input type="number" id="bgCustomWidth" min="1" value="800" aria-label="Custom background width">
        </label>
        <label>
          Custom Height (px)
          <input type="number" id="bgCustomHeight" min="1" value="400" aria-label="Custom background height">
        </label>
      </div>
      <div class="option-group">
        <label style="flex-direction: row; align-items: center;">
          <input type="checkbox" id="mirror" aria-label="Enable mirror mode"> Mirror Visualization
        </label>
      </div>
      <div class="option-group">
        <label>
          Visualization Transparency
          <input type="range" id="visualizationAlpha" min="0" max="1" step="0.01" value="1">
          <span id="alphaValue">100%</span>
        </label>
      </div>
      <div class="option-group">
        <label>
          Offset X (Horizontal Position)
          <input type="range" id="offsetX" min="-200" max="200" value="0">
          <span id="offsetXValue">0px</span>
        </label>
        <label>
          Offset Y (Vertical Position)
          <input type="range" id="offsetY" min="-200" max="200" value="0">
          <span id="offsetYValue">0px</span>
        </label>
      </div>
      <div class="option-group">
        <label>
          Layer Effect
          <select id="layerEffect" aria-label="Select layer effect">
            <option value="none" selected>None</option>
            <option value="blur">Blur</option>
            <option value="brightness">Brightness</option>
            <option value="contrast">Contrast</option>
            <option value="grayscale">Grayscale</option>
            <option value="invert">Invert</option>
            <option value="sepia">Sepia</option>
            <option value="saturate">Saturate</option>
            <option value="hue-rotate">Hue Rotate</option>
          </select>
        </label>
        <label>
          Effect Intensity
          <input type="range" id="layerEffectIntensity" min="0" max="100" value="50">
          <span id="layerEffectIntensityValue">50%</span>
        </label>
      </div>
    </div>

    <div class="recordings" id="recordings">
      <h3>Recordings</h3>
      <div id="recordingsList"></div>
    </div>
  </div>

  <script type="module">
    // Import from built library (in real usage, you'd import from the npm package)
    // For development, we'll use the UMD build
  </script>
  <script src="../dist/audio-recorder-visualization.umd.js"></script>
  <script>
    (async function() {
      // Wait for library to load
      await new Promise(resolve => {
        if (window.AudioRecorderVisualization) {
          resolve();
        } else {
          // Retry loading
          const interval = setInterval(() => {
            if (window.AudioRecorderVisualization) {
              clearInterval(interval);
              resolve();
            }
          }, 100);
        }
      });

      const { AudioRecorder, AudioToVideoConverter } = window.AudioRecorderVisualization;

      // Elements
      const canvas = document.getElementById('visualizer');
      const status = document.getElementById('status');
      const startMicBtn = document.getElementById('startMic');
      const stopMicBtn = document.getElementById('stopMic');
      const startRecordBtn = document.getElementById('startRecord');
      const stopRecordBtn = document.getElementById('stopRecord');
      const visualizerSelect = document.getElementById('visualizerSelect');
      const primaryColor = document.getElementById('primaryColor');
      const secondaryColor = document.getElementById('secondaryColor');
      const bgColor = document.getElementById('bgColor');
      const barCount = document.getElementById('barCount');
      const bgImage = document.getElementById('bgImage');
      const mirror = document.getElementById('mirror');
      const visualizationAlpha = document.getElementById('visualizationAlpha');
      const alphaValue = document.getElementById('alphaValue');
      const offsetX = document.getElementById('offsetX');
      const offsetXValue = document.getElementById('offsetXValue');
      const offsetY = document.getElementById('offsetY');
      const offsetYValue = document.getElementById('offsetYValue');
      const recordingsList = document.getElementById('recordingsList');
      const audioFile = document.getElementById('audioFile');
      const convertBtn = document.getElementById('convertBtn');
      const cancelConvertBtn = document.getElementById('cancelConvertBtn');
      const progressFill = document.getElementById('progressFill');
      const videoQuality = document.getElementById('videoQuality');
      const bgSizeMode = document.getElementById('bgSizeMode');
      const customSizeControls = document.getElementById('customSizeControls');
      const bgCustomWidth = document.getElementById('bgCustomWidth');
      const bgCustomHeight = document.getElementById('bgCustomHeight');
      const layerEffect = document.getElementById('layerEffect');
      const layerEffectIntensity = document.getElementById('layerEffectIntensity');
      const layerEffectIntensityValue = document.getElementById('layerEffectIntensityValue');

      // Settings persistence
      const SETTINGS_KEY = 'audio-recorder-settings';

      // Default settings
      const defaultSettings = {
        visualizer: 'bars',
        primaryColor: '#00ff88',
        secondaryColor: '#0088ff',
        backgroundColor: '#000000',
        barCount: 64,
        mirror: false,
        visualizationAlpha: 1,
        offsetX: 0,
        offsetY: 0,
        backgroundImage: null,
        backgroundSizeMode: 'cover',
        backgroundWidth: 800,
        backgroundHeight: 400,
        videoQuality: '1080p',
        layerEffect: 'none',
        layerEffectIntensity: 50,
      };

      // Load settings from localStorage
      function loadSettings() {
        try {
          const saved = localStorage.getItem(SETTINGS_KEY);
          if (saved) {
            return { ...defaultSettings, ...JSON.parse(saved) };
          }
        } catch (error) {
          console.warn('Failed to load settings:', error);
        }
        return defaultSettings;
      }

      // Save settings to localStorage
      function saveSettings(settings) {
        try {
          localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
        } catch (error) {
          console.warn('Failed to save settings:', error);
        }
      }

      // Track background image URL
      let currentBackgroundImageUrl = null;

      // Get current settings from UI
      function getCurrentSettings() {
        return {
          visualizer: visualizerSelect.value,
          primaryColor: primaryColor.value,
          secondaryColor: secondaryColor.value,
          backgroundColor: bgColor.value,
          barCount: parseInt(barCount.value),
          mirror: mirror.checked,
          visualizationAlpha: parseFloat(visualizationAlpha.value),
          offsetX: parseInt(offsetX.value),
          offsetY: parseInt(offsetY.value),
          backgroundImage: currentBackgroundImageUrl,
          backgroundSizeMode: bgSizeMode.value,
          backgroundWidth: parseInt(bgCustomWidth.value),
          backgroundHeight: parseInt(bgCustomHeight.value),
          videoQuality: videoQuality.value,
          layerEffect: layerEffect.value,
          layerEffectIntensity: parseInt(layerEffectIntensity.value),
        };
      }

      // Apply settings to UI
      function applySettings(settings) {
        visualizerSelect.value = settings.visualizer;
        primaryColor.value = settings.primaryColor;
        secondaryColor.value = settings.secondaryColor;
        bgColor.value = settings.backgroundColor;
        barCount.value = settings.barCount;
        document.getElementById('barCountValue').textContent = settings.barCount;
        mirror.checked = settings.mirror;
        visualizationAlpha.value = settings.visualizationAlpha;
        alphaValue.textContent = Math.round(settings.visualizationAlpha * 100) + '%';
        offsetX.value = settings.offsetX;
        offsetXValue.textContent = settings.offsetX + 'px';
        offsetY.value = settings.offsetY;
        offsetYValue.textContent = settings.offsetY + 'px';
        bgSizeMode.value = settings.backgroundSizeMode || 'cover';
        bgCustomWidth.value = settings.backgroundWidth || 800;
        bgCustomHeight.value = settings.backgroundHeight || 400;
        videoQuality.value = settings.videoQuality || '1080p';
        layerEffect.value = settings.layerEffect || 'none';
        layerEffectIntensity.value = settings.layerEffectIntensity || 50;
        layerEffectIntensityValue.textContent = (settings.layerEffectIntensity || 50) + '%';

        // Show/hide custom size controls based on mode
        customSizeControls.style.display = settings.backgroundSizeMode === 'custom' ? 'grid' : 'none';

        // Restore background image if saved
        if (settings.backgroundImage) {
          currentBackgroundImageUrl = settings.backgroundImage;
        }
      }

      // Load and apply saved settings on startup
      const savedSettings = loadSettings();
      applySettings(savedSettings);

      // Tab switching
      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          tab.classList.add('active');
          document.getElementById(tab.dataset.tab).classList.add('active');
        });
      });

      // Initialize AudioRecorder with saved settings
      const visualizerOptions = {
        primaryColor: savedSettings.primaryColor,
        secondaryColor: savedSettings.secondaryColor,
        backgroundColor: savedSettings.backgroundColor,
        barCount: savedSettings.barCount,
        mirror: savedSettings.mirror,
        visualizationAlpha: savedSettings.visualizationAlpha,
        offsetX: savedSettings.offsetX,
        offsetY: savedSettings.offsetY,
      };

      // Add background image if it was saved
      if (savedSettings.backgroundImage) {
        visualizerOptions.backgroundImage = savedSettings.backgroundImage;
      }

      const recorder = new AudioRecorder({
        canvas,
        fftSize: 2048,
        fps: 30,
        visualizer: savedSettings.visualizer,
        visualizerOptions,
        debug: true,
      });

      // Initialize converter
      const converter = new AudioToVideoConverter({ debug: true });

      // Recording counter
      let recordingCount = 0;

      // Update status
      function updateStatus(message, type = 'ready') {
        status.textContent = message;
        status.className = 'status ' + type;
      }

      // Start microphone
      startMicBtn.addEventListener('click', async () => {
        try {
          await recorder.startMicrophone();
          updateStatus('Microphone active - visualization running', 'ready');
          startMicBtn.disabled = true;
          stopMicBtn.disabled = false;
          startRecordBtn.disabled = false;
        } catch (error) {
          updateStatus('Error: ' + error.message, 'error');
          console.error(error);
        }
      });

      // Stop microphone
      stopMicBtn.addEventListener('click', () => {
        recorder.stopMicrophone();
        recorder.stopVisualization();
        updateStatus('Microphone stopped', 'ready');
        startMicBtn.disabled = false;
        stopMicBtn.disabled = true;
        startRecordBtn.disabled = true;
      });

      // Start recording
      startRecordBtn.addEventListener('click', () => {
        recorder.startRecording();
        updateStatus('Recording...', 'recording');
        startRecordBtn.disabled = true;
        stopRecordBtn.disabled = false;
      });

      // Stop recording
      stopRecordBtn.addEventListener('click', async () => {
        try {
          const blob = await recorder.stopRecording();
          updateStatus('Recording saved!', 'ready');
          startRecordBtn.disabled = false;
          stopRecordBtn.disabled = true;

          // Add to recordings list
          addRecording(blob);
        } catch (error) {
          updateStatus('Error: ' + error.message, 'error');
          console.error(error);
        }
      });

      // Add recording to list
      function addRecording(blob) {
        recordingCount++;
        const url = URL.createObjectURL(blob);
        const item = document.createElement('div');
        item.className = 'recording-item';

        const videoEl = document.createElement('video');
        videoEl.controls = true;
        videoEl.src = url;
        videoEl.width = 200;

        // Enable fullscreen on double-click
        videoEl.addEventListener('dblclick', () => {
          if (videoEl.requestFullscreen) {
            videoEl.requestFullscreen();
          } else if (videoEl.webkitRequestFullscreen) {
            videoEl.webkitRequestFullscreen();
          } else if (videoEl.mozRequestFullScreen) {
            videoEl.mozRequestFullScreen();
          } else if (videoEl.msRequestFullscreen) {
            videoEl.msRequestFullscreen();
          }
        });

        // Add title attribute for hint
        videoEl.title = 'Double-click for fullscreen';

        const infoDiv = document.createElement('div');
        const fileName = `recording-${recordingCount}.${blob.type.includes('mp4') ? 'mp4' : 'webm'}`;

        // Check if running in Electron
        const isElectron = window.electronAPI && window.electronAPI.isElectron;

        if (isElectron) {
          // Electron: Use IPC to save and show in folder
          infoDiv.innerHTML = `
            <p>Recording ${recordingCount}</p>
            <p>Size: ${(blob.size / 1024 / 1024).toFixed(2)} MB</p>
            <button class="btn-info" data-blob-index="${recordingCount}">Save and Show in Folder</button>
            <p style="font-size: 12px; color: #888; margin-top: 5px;">Double-click video for fullscreen</p>
          `;

          // Store blob reference for later use
          item.dataset.blobUrl = url;
          item.dataset.fileName = fileName;

          // Add click handler for save button
          const saveBtn = infoDiv.querySelector('button');
          saveBtn.addEventListener('click', async () => {
            try {
              saveBtn.disabled = true;
              saveBtn.textContent = 'Saving...';

              const result = await window.electronAPI.saveVideoAndShow(blob, fileName);

              if (result.success) {
                saveBtn.textContent = 'Saved!';
                setTimeout(() => {
                  saveBtn.textContent = 'Save and Show in Folder';
                  saveBtn.disabled = false;
                }, 2000);
              } else if (result.canceled) {
                saveBtn.textContent = 'Save and Show in Folder';
                saveBtn.disabled = false;
              } else {
                saveBtn.textContent = 'Error - Try Again';
                saveBtn.disabled = false;
                console.error('Save error:', result.error);
              }
            } catch (error) {
              console.error('Error saving video:', error);
              saveBtn.textContent = 'Error - Try Again';
              saveBtn.disabled = false;
            }
          });
        } else {
          // Browser: Use regular download link
          infoDiv.innerHTML = `
            <p>Recording ${recordingCount}</p>
            <p>Size: ${(blob.size / 1024 / 1024).toFixed(2)} MB</p>
            <a href="${url}" download="${fileName}">Download</a>
            <p style="font-size: 12px; color: #888; margin-top: 5px;">Double-click video for fullscreen</p>
          `;
        }

        item.appendChild(videoEl);
        item.appendChild(infoDiv);
        recordingsList.appendChild(item);
      }

      // Visualizer change
      visualizerSelect.addEventListener('change', () => {
        recorder.setVisualizer(visualizerSelect.value, getCurrentOptions());
        saveSettings(getCurrentSettings());
      });

      // Get current options
      function getCurrentOptions() {
        const options = {
          primaryColor: primaryColor.value,
          secondaryColor: secondaryColor.value,
          backgroundColor: bgColor.value,
          barCount: parseInt(barCount.value),
          mirror: mirror.checked,
          visualizationAlpha: parseFloat(visualizationAlpha.value),
          offsetX: parseInt(offsetX.value),
          offsetY: parseInt(offsetY.value),
          backgroundSizeMode: bgSizeMode.value,
          layerEffect: layerEffect.value,
          layerEffectIntensity: parseInt(layerEffectIntensity.value),
        };
        // Include background image if one is set
        if (currentBackgroundImageUrl) {
          options.backgroundImage = currentBackgroundImageUrl;
        }
        // Include custom dimensions if in custom mode
        if (bgSizeMode.value === 'custom') {
          options.backgroundWidth = parseInt(bgCustomWidth.value);
          options.backgroundHeight = parseInt(bgCustomHeight.value);
        }
        return options;
      }

      // Options change handlers
      [primaryColor, secondaryColor, bgColor, mirror].forEach(el => {
        el.addEventListener('input', () => {
          recorder.setVisualizerOptions(getCurrentOptions());
          saveSettings(getCurrentSettings());
        });
      });

      // Bar Count change handler with demo visualization and value display
      const barCountValue = document.getElementById('barCountValue');
      barCount.addEventListener('input', () => {
        const newBarCount = parseInt(barCount.value);
        barCountValue.textContent = newBarCount;
        recorder.setVisualizerOptions({ barCount: newBarCount });
        saveSettings(getCurrentSettings());

        // Show demo visualization if no audio source is active
        if (!recorder.sourceType) {
          recorder.showDemoVisualization(1000);
        }
      });

      // Visualization alpha handler with display update
      visualizationAlpha.addEventListener('input', () => {
        const alpha = parseFloat(visualizationAlpha.value);
        alphaValue.textContent = Math.round(alpha * 100) + '%';
        recorder.setVisualizerOptions({ visualizationAlpha: alpha });
        saveSettings(getCurrentSettings());
      });

      // Offset X handler with display update
      offsetX.addEventListener('input', () => {
        const x = parseInt(offsetX.value);
        offsetXValue.textContent = x + 'px';
        recorder.setVisualizerOptions({ offsetX: x });
        saveSettings(getCurrentSettings());
      });

      // Offset Y handler with display update
      offsetY.addEventListener('input', () => {
        const y = parseInt(offsetY.value);
        offsetYValue.textContent = y + 'px';
        recorder.setVisualizerOptions({ offsetY: y });
        saveSettings(getCurrentSettings());
      });

      // Layer effect handler
      layerEffect.addEventListener('change', () => {
        recorder.setVisualizerOptions(getCurrentOptions());
        saveSettings(getCurrentSettings());
      });

      // Layer effect intensity handler with display update
      layerEffectIntensity.addEventListener('input', () => {
        const intensity = parseInt(layerEffectIntensity.value);
        layerEffectIntensityValue.textContent = intensity + '%';
        recorder.setVisualizerOptions({ layerEffectIntensity: intensity });
        saveSettings(getCurrentSettings());
      });

      // Background image
      bgImage.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (file) {
          // Convert image to base64 data URL for persistence across sessions
          const reader = new FileReader();
          reader.onload = async (event) => {
            const dataUrl = event.target.result;
            currentBackgroundImageUrl = dataUrl;
            // Wait for image to load before continuing to prevent flickering
            await recorder.setVisualizerOptions({ backgroundImage: dataUrl });
            // Save settings with the new background image
            saveSettings(getCurrentSettings());
          };
          reader.readAsDataURL(file);
        }
      });

      // Background size mode change handler
      bgSizeMode.addEventListener('change', () => {
        const mode = bgSizeMode.value;
        customSizeControls.style.display = mode === 'custom' ? 'grid' : 'none';
        recorder.setVisualizerOptions(getCurrentOptions());
        saveSettings(getCurrentSettings());
      });

      // Custom background size handlers
      bgCustomWidth.addEventListener('input', () => {
        if (bgSizeMode.value === 'custom') {
          recorder.setVisualizerOptions(getCurrentOptions());
          saveSettings(getCurrentSettings());
        }
      });

      bgCustomHeight.addEventListener('input', () => {
        if (bgSizeMode.value === 'custom') {
          recorder.setVisualizerOptions(getCurrentOptions());
          saveSettings(getCurrentSettings());
        }
      });

      // Update progress bar with accessibility
      const progressBar = document.querySelector('.progress-bar');
      const updateProgress = (progress) => {
        const percentage = Math.round(progress * 100);
        progressBar.setAttribute('aria-valuenow', percentage);
        progressFill.style.width = percentage + '%';
      };

      // Audio file for conversion
      audioFile.addEventListener('change', () => {
        convertBtn.disabled = !audioFile.files.length;
      });

      // Convert audio to video
      convertBtn.addEventListener('click', async () => {
        const file = audioFile.files[0];
        if (!file) return;

        convertBtn.disabled = true;
        convertBtn.style.display = 'none';
        cancelConvertBtn.style.display = 'inline-flex';
        progressBar.style.display = 'block';
        updateStatus('Converting audio to video...', 'recording');

        // Pause AudioRecorder visualization during conversion to prevent flickering
        // (both would draw to the same canvas causing visual artifacts)
        const wasVisualizationActive = recorder.isVisualizationActive;
        if (wasVisualizationActive) {
          recorder.stopVisualization();
        }

        try {
          // Get video dimensions based on quality setting
          const qualityMap = {
            '720p': { width: 1280, height: 720 },
            '1080p': { width: 1920, height: 1080 },
            '1440p': { width: 2560, height: 1440 },
            '2160p': { width: 3840, height: 2160 },
          };
          const quality = qualityMap[videoQuality.value] || qualityMap['1080p'];

          const blob = await converter.convert({
            audioSource: file,
            canvas,
            visualizer: visualizerSelect.value,
            visualizerOptions: getCurrentOptions(),
            fps: 30,
            videoWidth: quality.width,
            videoHeight: quality.height,
            onProgress: updateProgress,
          });

          updateStatus('Conversion complete!', 'ready');
          addRecording(blob);
        } catch (error) {
          if (error.message.includes('cancelled')) {
            updateStatus('Conversion cancelled', 'ready');
          } else {
            updateStatus('Error: ' + error.message, 'error');
          }
          console.error(error);
        } finally {
          convertBtn.disabled = false;
          convertBtn.style.display = 'inline-flex';
          cancelConvertBtn.style.display = 'none';
          progressBar.style.display = 'none';
          updateProgress(0);

          // Resume AudioRecorder visualization if it was active before conversion
          if (wasVisualizationActive && recorder.sourceType) {
            recorder.resumeVisualization();
          }
        }
      });

      // Cancel conversion
      cancelConvertBtn.addEventListener('click', () => {
        converter.cancel();
        updateStatus('Cancelling conversion...', 'ready');
      });

      // Add mouse wheel support for all range sliders
      const rangeInputs = document.querySelectorAll('input[type="range"]');
      rangeInputs.forEach(slider => {
        slider.addEventListener('wheel', (e) => {
          e.preventDefault();
          const step = parseFloat(slider.step) || 1;
          const delta = e.deltaY < 0 ? step : -step;
          const newValue = parseFloat(slider.value) + delta;
          const min = parseFloat(slider.min);
          const max = parseFloat(slider.max);

          if (newValue >= min && newValue <= max) {
            slider.value = newValue;
            // Trigger input event to update the visualization
            slider.dispatchEvent(new Event('input', { bubbles: true }));
          }
        }, { passive: false });
      });

      // Keyboard shortcuts for better UX
      document.addEventListener('keydown', (e) => {
        // Prevent shortcuts when typing in inputs
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT' || e.target.tagName === 'TEXTAREA') {
          return;
        }

        // Space: Start/Stop microphone
        if (e.code === 'Space') {
          e.preventDefault();
          if (!startMicBtn.disabled) {
            startMicBtn.click();
          } else if (!stopMicBtn.disabled) {
            stopMicBtn.click();
          }
        }

        // R: Start/Stop recording
        if (e.code === 'KeyR') {
          e.preventDefault();
          if (!startRecordBtn.disabled) {
            startRecordBtn.click();
          } else if (!stopRecordBtn.disabled) {
            stopRecordBtn.click();
          }
        }

        // 1-8: Switch visualizers
        if (e.code >= 'Digit1' && e.code <= 'Digit8') {
          e.preventDefault();
          const visualizers = ['bars', 'waveform', 'circular', 'particles', 'spectrum-gradient', 'glow-waveform', 'vu-meter', 'spectrogram'];
          const index = parseInt(e.code.replace('Digit', '')) - 1;
          if (visualizers[index]) {
            visualizerSelect.value = visualizers[index];
            visualizerSelect.dispatchEvent(new Event('change'));
          }
        }

        // M: Toggle mirror mode
        if (e.code === 'KeyM') {
          e.preventDefault();
          mirror.checked = !mirror.checked;
          mirror.dispatchEvent(new Event('input'));
        }

        // Arrow keys: Adjust bar count
        if (e.code === 'ArrowUp' || e.code === 'ArrowDown') {
          e.preventDefault();
          const currentValue = parseInt(barCount.value);
          const step = 8;
          if (e.code === 'ArrowUp' && currentValue < 256) {
            barCount.value = Math.min(256, currentValue + step);
          } else if (e.code === 'ArrowDown' && currentValue > 16) {
            barCount.value = Math.max(16, currentValue - step);
          }
          barCount.dispatchEvent(new Event('input'));
        }

        // ? or /: Show keyboard shortcuts help
        if (e.key === '?' || e.key === '/') {
          e.preventDefault();
          alert(`Keyboard Shortcuts:

Space - Start/Stop Microphone
R - Start/Stop Recording
1-8 - Switch Visualizers:
  1=Bars, 2=Waveform, 3=Circular, 4=Particles
  5=Spectrum Gradient, 6=Glow Waveform, 7=VU Meter, 8=Spectrogram
M - Toggle Mirror Mode
↑/↓ - Adjust Bar Count
? or / - Show this help`);
        }
      });

      // Show available visualizers in console
      console.log('Available visualizers:', AudioRecorder.getAvailableVisualizers());
      console.log('Supported formats:', AudioRecorder.getSupportedFormats());
      console.log('Keyboard shortcuts: Press ? or / for help');
    })();
  </script>
</body>
</html>
